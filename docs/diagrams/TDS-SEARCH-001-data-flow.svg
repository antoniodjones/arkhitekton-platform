<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg viewBox="0 0 1000 850" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#2d3748"/>
    </marker>
    <marker id="arrow-green" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#48bb78"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="500" y="30" font-family="Arial" font-size="20" font-weight="bold" fill="#1a202c" text-anchor="middle">Global Search - Data Flow Diagram</text>
  <text x="500" y="50" font-family="Arial" font-size="12" fill="#4a5568" text-anchor="middle">How data flows through the search system</text>

  <!-- External: User (Input) -->
  <ellipse cx="80" cy="120" rx="60" ry="30" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
  <text x="80" y="117" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">User</text>
  <text x="80" y="132" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">Search Query</text>

  <!-- P1: Input Handler -->
  <rect x="180" y="90" width="130" height="60" fill="#edf2f7" stroke="#4299e1" stroke-width="2" rx="6"/>
  <text x="245" y="110" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">P1: Input Handler</text>
  <text x="245" y="125" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">Dashboard</text>
  <text x="245" y="140" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">Debounce 300ms</text>

  <!-- Flow 1: User to P1 -->
  <path d="M 140 120 L 180 120" stroke="#2d3748" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
  <text x="160" y="110" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">Raw Input</text>
  <text x="160" y="135" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">"wiki-rtf"</text>

  <!-- P2: Query Builder -->
  <rect x="350" y="90" width="130" height="60" fill="#edf2f7" stroke="#4299e1" stroke-width="2" rx="6"/>
  <text x="415" y="110" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">P2: Query Builder</text>
  <text x="415" y="125" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">useGlobalSearch</text>
  <text x="415" y="140" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">Build API Request</text>

  <!-- Flow 2: P1 to P2 -->
  <path d="M 310 120 L 350 120" stroke="#2d3748" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
  <text x="330" y="110" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">Debounced</text>
  <text x="330" y="135" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">query string</text>

  <!-- D1: Client Cache - ALIGNED with P2 at y=90 -->
  <path d="M 550 90 L 670 90 L 670 150 L 550 150 Z" fill="#fff5f5" stroke="#fc8181" stroke-width="2"/>
  <text x="610" y="110" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">D1: Client Cache</text>
  <text x="610" y="125" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">React Query</text>
  <text x="610" y="140" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">5 min stale</text>

  <!-- Check cache: P2 to D1 (horizontal, like P5→D2) -->
  <path d="M 480 120 L 550 120" stroke="#2d3748" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
  <text x="515" y="113" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">Check cache</text>
  <text x="515" y="147" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">cache key</text>

  <!-- Cache hit: D1 back to P2 (horizontal return, like D2→P5) -->
  <path d="M 550 130 L 480 130" stroke="#48bb78" stroke-width="2" fill="none" marker-end="url(#arrow-green)"/>
  <text x="515" y="160" font-family="Arial" font-size="9" fill="#48bb78" text-anchor="middle">✓ Cache HIT (bypass API)</text>

  <!-- P3: API Request -->
  <rect x="350" y="200" width="130" height="60" fill="#edf2f7" stroke="#4299e1" stroke-width="2" rx="6"/>
  <text x="415" y="220" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">P3: API Request</text>
  <text x="415" y="235" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">HTTP Client</text>
  <text x="415" y="250" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">GET /search</text>

  <!-- Cache miss: P2 to P3 -->
  <path d="M 415 150 L 415 200" stroke="#fc8181" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
  <text x="435" y="180" font-family="Arial" font-size="9" fill="#fc8181" text-anchor="middle">✗ MISS</text>

  <!-- Flow: P3 to Query Params -->
  <path d="M 480 230 L 540 230" stroke="#2d3748" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

  <!-- Query params box - centered between D1 and D2 (horizontally and vertically) -->
  <rect x="540" y="220" width="140" height="50" fill="#fffaf0" stroke="#ed8936" stroke-width="1" stroke-dasharray="3,3" rx="4"/>
  <text x="610" y="235" font-family="Arial" font-size="9" font-weight="bold" fill="#4a5568" text-anchor="middle">Query Params:</text>
  <text x="610" y="250" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">?q=wiki-rtf</text>
  <text x="610" y="263" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">&amp;limit=10</text>

  <!-- P4: Search Controller -->
  <rect x="180" y="340" width="130" height="60" fill="#edf2f7" stroke="#4299e1" stroke-width="2" rx="6"/>
  <text x="245" y="360" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">P4: Search Logic</text>
  <text x="245" y="375" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">Express Handler</text>
  <text x="245" y="390" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">Parse &amp; Validate</text>

  <!-- Flow 4: P3 to P4 (HTTP Request) -->
  <path d="M 415 260 L 415 370 L 310 370" stroke="#2d3748" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
  <text x="425" y="320" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">HTTP</text>
  <text x="425" y="333" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">Request</text>

  <!-- P5: Storage -->
  <rect x="350" y="340" width="130" height="60" fill="#edf2f7" stroke="#4299e1" stroke-width="2" rx="6"/>
  <text x="415" y="360" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">P5: Storage</text>
  <text x="415" y="375" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">IStorage Interface</text>
  <text x="415" y="390" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">getAllUserStories()</text>

  <!-- Flow 5: P4 to P5 -->
  <path d="M 310 370 L 350 370" stroke="#2d3748" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
  <text x="330" y="363" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">Query</text>

  <!-- D2: PostgreSQL -->
  <path d="M 550 340 L 670 340 L 670 400 L 550 400 Z" fill="#fef5e7" stroke="#f6ad55" stroke-width="2"/>
  <text x="610" y="360" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">D2: PostgreSQL</text>
  <text x="610" y="375" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">Tables + Indexes</text>
  <text x="610" y="390" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">FTS, Trigram</text>

  <!-- Query DB: P5 to D2 -->
  <path d="M 480 370 L 550 370" stroke="#2d3748" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
  <text x="515" y="363" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">SQL Query</text>
  <text x="515" y="390" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">ILIKE, ts_rank()</text>

  <!-- Return rows: D2 to P5 - moved label down to avoid overlap -->
  <path d="M 550 380 L 480 380" stroke="#48bb78" stroke-width="2" fill="none" marker-end="url(#arrow-green)"/>
  <text x="515" y="410" font-family="Arial" font-size="9" fill="#48bb78" text-anchor="middle">14 rows</text>

  <!-- P6: Scoring -->
  <rect x="180" y="480" width="130" height="60" fill="#edf2f7" stroke="#4299e1" stroke-width="2" rx="6"/>
  <text x="245" y="500" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">P6: Scoring</text>
  <text x="245" y="515" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">Calculate Relevance</text>
  <text x="245" y="530" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">Sort &amp; Rank</text>

  <!-- Flow 6: P5 to P6 -->
  <path d="M 415 400 L 415 510 L 310 510" stroke="#2d3748" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
  <text x="425" y="460" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">Raw</text>
  <text x="425" y="473" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">Results</text>

  <!-- Scoring box -->
  <rect x="350" y="485" width="180" height="70" fill="#fffaf0" stroke="#ed8936" stroke-width="1" stroke-dasharray="3,3" rx="4"/>
  <text x="440" y="500" font-family="Arial" font-size="9" font-weight="bold" fill="#4a5568" text-anchor="middle">Scoring Algorithm:</text>
  <text x="440" y="515" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">Exact ID: +100</text>
  <text x="440" y="528" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">Title: +80, Desc: +20</text>
  <text x="440" y="541" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">Recency: +10, Status: +10</text>

  <!-- P7: Formatter -->
  <rect x="180" y="610" width="130" height="60" fill="#edf2f7" stroke="#4299e1" stroke-width="2" rx="6"/>
  <text x="245" y="630" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">P7: Formatter</text>
  <text x="245" y="645" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">SearchResponse</text>
  <text x="245" y="660" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">Add metadata</text>

  <!-- Flow 7: P6 to P7 -->
  <path d="M 245 540 L 245 610" stroke="#2d3748" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
  <text x="265" y="580" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">Scored &amp;</text>
  <text x="265" y="593" font-family="Arial" font-size="9" fill="#2d3748" text-anchor="middle">Sorted</text>

  <!-- Response box -->
  <rect x="350" y="615" width="200" height="55" fill="#fffaf0" stroke="#ed8936" stroke-width="1" stroke-dasharray="3,3" rx="4"/>
  <text x="450" y="630" font-family="Arial" font-size="9" font-weight="bold" fill="#4a5568" text-anchor="middle">SearchResponse:</text>
  <text x="450" y="645" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">{query, totalResults, limit,</text>
  <text x="450" y="658" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">offset, hasMore, results[], grouped{}}</text>

  <!-- Return to client: P7 to P3 (zigzag up left side, across top) -->
  <!-- Using x=100 to separate from the other left arrow -->
  <path d="M 180 640 L 100 640 L 100 230 L 350 230" stroke="#48bb78" stroke-width="2" fill="none" marker-end="url(#arrow-green)"/>
  <text x="85" y="435" font-family="Arial" font-size="9" fill="#48bb78" text-anchor="middle">JSON</text>
  <text x="85" y="448" font-family="Arial" font-size="9" fill="#48bb78" text-anchor="middle">Response</text>
  <text x="85" y="461" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">(P7→P3)</text>

  <!-- Store in cache: P3 to D1 (after receiving response) -->
  <path d="M 480 215 L 530 215 L 530 120 L 550 120" stroke="#4299e1" stroke-width="2" fill="none" marker-end="url(#arrow)" stroke-dasharray="5,5"/>
  <text x="540" y="165" font-family="Arial" font-size="9" fill="#4299e1" text-anchor="middle">Store</text>
  <text x="540" y="178" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">(5 min TTL)</text>

  <!-- Final display to user -->
  <ellipse cx="80" cy="770" rx="60" ry="30" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
  <text x="80" y="767" font-family="Arial" font-size="11" font-weight="bold" fill="#2d3748" text-anchor="middle">User</text>
  <text x="80" y="782" font-family="Arial" font-size="9" fill="#4a5568" text-anchor="middle">View Results</text>

  <!-- Flow 8: P1 to User (display) - using x=145 to separate from other arrow -->
  <path d="M 180 120 L 145 120 L 145 770 L 140 770" stroke="#48bb78" stroke-width="2" fill="none" marker-end="url(#arrow-green)"/>
  <text x="130" y="445" font-family="Arial" font-size="9" fill="#48bb78" text-anchor="middle">Display</text>
  <text x="130" y="458" font-family="Arial" font-size="9" fill="#48bb78" text-anchor="middle">14 Cards</text>
  <text x="130" y="471" font-family="Arial" font-size="8" fill="#4a5568" text-anchor="middle">(P1→User)</text>

  <!-- Legend -->
  <rect x="730" y="90" width="240" height="220" fill="#f9fafb" stroke="#cbd5e0" stroke-width="2" rx="6"/>
  <text x="850" y="115" font-family="Arial" font-size="12" font-weight="bold" fill="#2d3748" text-anchor="middle">Legend</text>

  <rect x="750" y="130" width="60" height="30" fill="#edf2f7" stroke="#4299e1" stroke-width="2" rx="4"/>
  <text x="825" y="150" font-family="Arial" font-size="10" fill="#4a5568">Process</text>

  <path d="M 750 175 L 810 175 L 810 195 L 750 195 Z" fill="#fef5e7" stroke="#f6ad55" stroke-width="2"/>
  <text x="825" y="190" font-family="Arial" font-size="10" fill="#4a5568">Data Store</text>

  <ellipse cx="780" cy="220" rx="30" ry="15" fill="#f0fff4" stroke="#48bb78" stroke-width="2"/>
  <text x="825" y="225" font-family="Arial" font-size="10" fill="#4a5568">External</text>

  <rect x="750" y="240" width="60" height="25" fill="#fffaf0" stroke="#ed8936" stroke-width="1" stroke-dasharray="3,3" rx="4"/>
  <text x="825" y="257" font-family="Arial" font-size="10" fill="#4a5568">Transform</text>

  <line x1="750" y1="280" x2="810" y2="280" stroke="#2d3748" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="825" y="285" font-family="Arial" font-size="10" fill="#4a5568">Data Flow</text>

  <!-- Performance -->
  <rect x="730" y="340" width="240" height="120" fill="#f0fff4" stroke="#48bb78" stroke-width="2" rx="6"/>
  <text x="850" y="365" font-family="Arial" font-size="12" font-weight="bold" fill="#2d3748" text-anchor="middle">Performance</text>
  <text x="850" y="385" font-family="Arial" font-size="10" fill="#4a5568" text-anchor="middle">Cache Hit: ~10ms</text>
  <text x="850" y="405" font-family="Arial" font-size="10" fill="#4a5568" text-anchor="middle">Cache Miss: ~650ms</text>
  <text x="850" y="425" font-family="Arial" font-size="10" fill="#4a5568" text-anchor="middle">DB Query: ~600ms</text>
  <text x="850" y="445" font-family="Arial" font-size="10" fill="#4a5568" text-anchor="middle">Scoring: ~30ms</text>

  <!-- Data Volume -->
  <rect x="730" y="490" width="240" height="90" fill="#fffaf0" stroke="#ed8936" stroke-width="2" rx="6"/>
  <text x="850" y="515" font-family="Arial" font-size="12" font-weight="bold" fill="#2d3748" text-anchor="middle">Data Volume</text>
  <text x="850" y="535" font-family="Arial" font-size="10" fill="#4a5568" text-anchor="middle">Input: 8 chars ("wiki-rtf")</text>
  <text x="850" y="555" font-family="Arial" font-size="10" fill="#4a5568" text-anchor="middle">DB Rows Scanned: ~2000</text>
  <text x="850" y="575" font-family="Arial" font-size="10" fill="#4a5568" text-anchor="middle">Results Returned: 14</text>
</svg>
